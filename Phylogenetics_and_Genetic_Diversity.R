# Phylogenetics_and_Genetic_Diversity.R
# Comprehensive analysis of ToBRFV genetic diversity and phylogenetics.

# ==========================
# Load Required Libraries
# ==========================
if (!requireNamespace("BiocManager", quietly = TRUE)) install.packages("BiocManager")
BiocManager::install(c("ggtree", "treeio", "ape", "phangorn", "pheatmap", "fmsb", "ggplot2","DECIPHER","pheatmap","pegas","adegenet","poppr"))
library(ggtree)
library(treeio)
library(ape)
library(phangorn)
library(pheatmap)
library(fmsb)
library(ggplot2)
library(DECIPHER)
library(pheatmap)
library(pegas)
library(adegenet)
library(poppr)
library(kableExtra)


# ==========================
# Set Working Directory
# ==========================
# Update this path with the directory containing your data files
setwd("/Users/katiaavinapadilla/Desktop/SECUENCIASDEPSOMAGENERIKA/")

# ==========================
# Phylogenetic Tree Analysis
# ==========================

# Read the consensus tree generated by IQ-TREE
tree <- read.tree("Resultado_Alignment.aln.contree")

# Create the tree visualization with bootstrap values in ggtree
p <- ggtree(tree, layout = "rectangular") +
  geom_tree(aes(color = branch.length), size = 0.5) + # Color by branch length
  scale_color_viridis_c() + # Professional color scale (viridis)
  theme_minimal() + 
  theme(panel.background = element_rect(fill = "white", color = "white"),
        plot.background = element_rect(fill = "white", color = "white"),
        plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
        legend.position = "right") +
  geom_tiplab(aes(label = label), size = 2.5, color = "darkblue", hjust = -0.2) + # Node labels
  geom_text2(aes(subset = !is.na(as.numeric(label)) & as.numeric(label) >= 70, # Display bootstrap values >= 70
                 label = label), color = "red", hjust = -0.2, size = 3) + #  Red color for high bootstrap values
  ggtitle("Phylogenetic Tree of ToBRFV Isolates") 

# Display the plot
print(p)

# ==========================
# Neighbor-Net Network
# ==========================
# Load the alignment
alignment <- read.dna("/Users/katiaavinapadilla/Desktop/SECUENCIASDEPSOMAGENERIKA/lcl|Query_2456347.aln", format = "fasta")
#Calculate the distance matrix 
#We will use Kimura 2 model (K80) to compute the distance matriz among sequences 
dist_matrix <- dist.dna(alignment, model = "K80")
#Build the network Neighbor-Net
net <- neighborNet(dist_matrix)
# Extract the ID
labels <- sapply(net$tip.label, function(label) {
  match <- regmatches(label, regexpr("(?<=\\|)[^|]+(?=\\|)", label, perl = TRUE))
  if (length(match) > 0) {
    return(match)  
  } else {
    return(label) 
  }
})

# Asign the labels
net$tip.label <- labels
#plot the network
plot(net, tip.color = ifelse(net$tip.label == "Mexican_isolate", "red", "black"))


# ==========================
# Pairwise Sequence Identity Heatmap
# ==========================

# Load the alignment file
alignment <- read.dna("lcl|Query_2456347.aln", format = "fasta")

# Compute pairwise sequence identity
distance_matrix <- dist.dna(alignment, model = "K80")

# Convertir distancias a porcentajes de identidad
identity_matrix <- 1 - distance_matrix
identity_matrix <- as.matrix(identity_matrix) * 100  # Convertir a matriz y a porcentaje

# Simplificar los nombres de los labels extrayendo solo el identificador único
colnames(identity_matrix) <- sapply(colnames(identity_matrix), function(label) {
  match <- regmatches(label, regexpr("(?<=\\|)[A-Za-z0-9]+\\.[0-9]+", label, perl = TRUE))
  if (length(match) > 0) {
    return(match)
  } else {
    return(substring(label, 1, 10))  # Limitar a los primeros 10 caracteres si no se encuentra el patrón
  }
})

rownames(identity_matrix) <- colnames(identity_matrix)  # Aplicar también a las filas, si es necesario
pheatmap(identity_matrix,
         color = colorRampPalette(c("blue", "green", "yellow", "red"))(50),
         main = "Pairwise Sequence Identities (%) Between ToBRFV Isolates",
         fontsize_row = 6,
         fontsize_col = 6,
         cellwidth = 8,
         cellheight = 8,
         angle_col = 45)
pdf("Pairwise_Sequence_Identities_Enhanced.pdf", width = 20, height = 20)


# ==========================
# Genetic Diversity Metrics and Radar Plot
# ==========================
# Calculate the number of haplotypes (H) and haplotype diversity (Hd)
H <- nrow(haplotypes)  # Number of haplotypes
Hd <- hap.div(haplotypes)  # Haplotype diversity

# Calculate the number of polymorphic sites (S)
polymorphic_sites <- seg.sites(alignment)
S <- length(polymorphic_sites)  # Polymorphic sites

# Calculate nucleotide diversity (π) and average nucleotide differences (k)
pi <- nuc.div(alignment)  # Nucleotide diversity
k <- pi * nrow(alignment)  # Average nucleotide differences

# Print results
cat("Number of Haplotypes (H):", H, "\n")
cat("Haplotype Diversity (Hd):", Hd, "\n")
cat("Number of Polymorphic Sites (S):", S, "\n")
cat("Nucleotide Diversity (π):", pi, "\n")
cat("Average Nucleotide Differences (k):", k, "\n")

# Create a results table
results <- data.frame(
  Parameter = c("Number of Haplotypes (H)", "Haplotype Diversity (Hd)", "Polymorphic Sites (S)",
                "Nucleotide Diversity (π)", "Average Nucleotide Differences (k)"),
  Value = c(H, Hd, S, pi, k)
)

# Display the results table
print(results)


# Radar plot
data_radar <- rbind(rep(max(resultados$Value), 5), rep(min(resultados$Value), 5), resultados$Value)
colnames(data_radar) <- resultados$Parameter



# reate a dataframe with parameters and values, including maximum and minimum values
data_radar <- data.frame(
  "Number of Haplotypes (H)" = c(80, 0, H),
  "Haplotype Diversity (Hd)" = c(1, 0, Hd),
  "Polymorphic Sites (S)" = c(250, 0, S),
  "Nucleotide Diversity (π)" = c(0.01, 0, pi),
  "Average Nucleotide Differences (k)" = c(0.5, 0, k)
)

# Create the radar chart
radarchart(data_radar, axistype = 1,
           pcol = rgb(0.2, 0.5, 0.5, 0.9),  # Line color
           pfcol = rgb(0.2, 0.5, 0.5, 0.5), # Fill color
           plwd = 2,                        # Line thickness
           cglcol = "grey",                 # Grid line color
           cglty = 1,                       # Grid line type
           axislabcol = "grey",             # Axis label color
           caxislabels = seq(0, 1, 0.2),    # Axis labels
           cglwd = 0.8,                     # Grid line thickness
           vlcex = 0.8)                     # Vertex label size

title(main = "Genetic Diversity Parameters of ToBRFV")


# ==========================
# End of Script
# ==========================
